<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.tju.core.security.mappers.UserMapper">
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        insert into users values (#{id},#{createTime},#{creator},#{deleted},#{updateTime},#{updater},#{activated},#{password},#{username})
    </insert>


    <update id="update">
        update users
        <set>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="creator != null">
                creator = #{creator},
            </if>
            <if test="deleted != null">
                is_deleted = #{deleted},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="updater != null">
                updater = #{updater},
            </if>
            <if test="activated != null">
                activated = #{activated},
            </if>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="username != null and username != ''">
                username = #{username},
            </if>
        </set>
        where id = #{id}
    </update>


    <select id="findAll" resultType="cn.edu.tju.core.model.User">

    </select>



    <!-- 1. 权限结果映射 -->
    <resultMap id="authorityResultMap" type="cn.edu.tju.core.model.Authority">
        <id property="name" column="authority_name"/>
    </resultMap>

    <!-- 2. 用户结果映射 -->
    <resultMap id="userResultMap" type="cn.edu.tju.core.model.User">
        <id property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="creator" column="creator"/>
        <result property="deleted" column="is_deleted" typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="updateTime" column="update_time"/>
        <result property="updater" column="updater"/>
        <result property="activated" column="activated" typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="password" column="password"/>
        <result property="username" column="username"/>

        <!-- 3. 把权限集合封装到 authorities -->
        <collection property="authorities"
                    ofType="cn.edu.tju.core.model.Authority"
                    resultMap="authorityResultMap"/>
    </resultMap>

    <!-- 4. 根据用户名查用户（含权限） -->
    <select id="findOneWithAuthoritiesByUsername" resultMap="userResultMap">
        SELECT u.id,
               u.create_time,
               u.creator,
               u.is_deleted,
               u.update_time,
               u.updater,
               u.activated,
               u.password,
               u.username,
               a.name AS authority_name
        FROM users u
                 LEFT JOIN user_authority ua ON u.id = ua.user_id
                 LEFT JOIN authority a ON ua.authority_name = a.name
        WHERE u.username = #{username}
    </select>

</mapper>