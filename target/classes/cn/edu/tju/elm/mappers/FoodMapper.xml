<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.tju.elm.mappers.FoodMapper">


    <!-- 1. 权限结果映射 -->
    <resultMap id="authorityResultMap" type="cn.edu.tju.core.model.Authority">
        <id property="name" column="authority_name"/>
    </resultMap>

    <!-- 2. 用户结果映射 -->
    <resultMap id="userResultMap" type="cn.edu.tju.core.model.User">
        <id property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="creator" column="creator"/>
        <result property="deleted" column="is_deleted" typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="updateTime" column="update_time"/>
        <result property="updater" column="updater"/>
        <result property="activated" column="activated" typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="password" column="password"/>
        <result property="username" column="username"/>

        <!-- 3. 把权限集合封装到 authorities -->
        <collection property="authorities"
                    ofType="cn.edu.tju.core.model.Authority"
                    resultMap="authorityResultMap"/>
    </resultMap>


    <resultMap id = "FoodMapResult" type="cn.edu.tju.elm.model.Food">
        <id column="food_id" property="id"/>
        <result column="food_create_time" property="createTime"/>
        <result column="food_creator" property="creator"/>
        <result column="food_is_deleted" property="deleted"/>
        <result column="food_update_time" property="updateTime"/>
        <result column="food_updater" property="updater"/>
        <result column="food_explain" property="foodExplain"/>
        <result column="food_img" property="foodImg"/>
        <result column="food_name" property="foodName"/>
        <result column="food_price" property="foodPrice"/>
        <result column="food_remarks" property="remarks"/>

        <!-- Business-->
        <association property="business" javaType="cn.edu.tju.elm.model.Business">
            <id column="b_business_id" property="id"/>
            <result column="b_create_time" property="createTime"/>
            <result column="b_creator" property="creator"/>
            <result column="b_is_deleted" property="deleted"/>
            <result column="b_update_time" property="updateTime"/>
            <result column="b_updater" property="updater"/>
            <result column="business_address" property="businessAddress"/>
            <result column="business_img" property="businessImg"/>
            <result column="business_name" property="businessName"/>
            <result column="delivery_price" property="deliveryPrice"/>
            <result column="order_type_id" property="orderTypeId"/>
            <result column="b_remarks" property="remarks"/>
            <result column="b_start_price" property="startPrice"/>

            <!-- user wuth auth-->
            <association property="businessOwner" resultMap="userResultMap">

            </association>


        </association>

    </resultMap>
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        insert into food values (null,#{createTime},#{creator},#{deleted},#{updateTime},#{updater},#{foodExplain},#{foodImg},#{foodName},#{foodPrice},#{remarks},#{businessId})
    </insert>


    <select id="selectById" resultMap="FoodMapResult">
        SELECT
            f.id AS food_id,
            f.create_time AS food_create_time,
            f.creator AS food_creator,
            f.is_deleted AS food_is_deleted,
            f.update_time AS food_update_time,
            f.updater AS food_updater,
            f.food_explain AS food_explain,
            f.food_img AS food_img,
            f.food_name AS food_name,
            f.food_price AS food_price,
            f.remarks AS food_remarks,

            b.id AS b_business_id,
            b.create_time AS b_create_time,
            b.creator AS b_creator,
            b.is_deleted AS b_is_deleted,
            b.update_time AS b_update_time,
            b.updater AS b_updater,
            b.business_address AS business_address,
            b.business_img AS business_img,
            b.business_name AS business_name,
            b.delivery_price,
            b.order_type_id,
            b.remarks AS b_remarks,
            b.start_price AS b_start_price,

            u.id AS id,
            u.create_time AS create_time,
            u.creator AS creator,
            u.is_deleted AS is_deleted,
            u.update_time AS update_time,
            u.updater AS updater,
            u.activated AS activated,
            u.password AS password,
            u.username AS username,

            a.name AS authority_name

        FROM food f
                 LEFT JOIN business b ON f.business_id = b.id
                 LEFT JOIN users u ON b.user_id = u.id
                 LEFT JOIN user_authority ua ON u.id = ua.user_id
                 LEFT JOIN authority a ON ua.authority_name = a.name
        WHERE f.id = #{id}
    </select>

    <select id="getFoodByIdAndBus" resultMap="FoodMapResult">
        SELECT
            f.id AS food_id,
            f.create_time AS food_create_time,
            f.creator AS food_creator,
            f.is_deleted AS food_is_deleted,
            f.update_time AS food_update_time,
            f.updater AS food_updater,
            f.food_explain AS food_explain,
            f.food_img AS food_img,
            f.food_name AS food_name,
            f.food_price AS food_price,
            f.remarks AS food_remarks,

            b.id AS b_business_id,
            b.create_time AS b_create_time,
            b.creator AS b_creator,
            b.is_deleted AS b_is_deleted,
            b.update_time AS b_update_time,
            b.updater AS b_updater,
            b.business_address AS business_address,
            b.business_img AS business_img,
            b.business_name AS business_name,
            b.delivery_price,
            b.order_type_id,
            b.remarks AS b_remarks,
            b.start_price AS b_start_price,

            u.id AS id,
            u.create_time AS create_time,
            u.creator AS creator,
            u.is_deleted AS is_deleted,
            u.update_time AS update_time,
            u.updater AS updater,
            u.activated AS activated,
            u.password AS password,
            u.username AS username,

            a.name AS authority_name

        FROM food f
                 LEFT JOIN business b ON f.business_id = b.id
                 LEFT JOIN users u ON b.user_id = u.id
                 LEFT JOIN user_authority ua ON u.id = ua.user_id
                 LEFT JOIN authority a ON ua.authority_name = a.name
        WHERE f.id = #{id} and f.business_id = #{businessId}
    </select>


</mapper>